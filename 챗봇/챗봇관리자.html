<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>GoHigher ì±—ë´‡ ë¬¸ì˜ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { background: #e8eaf6; min-height: 100vh; margin:0; font-family: 'Segoe UI', Arial, sans-serif; }
    .admin-wrap { max-width: 680px; margin: 50px auto; background:#fff; border-radius:18px; box-shadow:0 4px 24px #243c8d22; padding:36px 24px 32px 24px;}
    .admin-title { color: #2563eb; font-size: 1.34rem; font-weight: 900; margin-bottom: 24px;}
    .inquiry-list { margin-top:18px; }
    .inquiry-item { background:#f5f7fa; border-radius:10px; padding:16px 14px; margin-bottom:14px; box-shadow:0 2px 8px #243c8d18; text-align:left;}
    .inquiry-meta { color:#435; font-size:0.98rem; margin-bottom:3px;}
    .inquiry-msg { margin-bottom:7px; color:#133; }
    .reply-form { display:flex; gap:7px; align-items:center; margin-top:9px; }
    .reply-form input { flex:1; font-size:1rem; border:1px solid #b4c5e4; border-radius:7px; padding:8px;}
    .reply-form button { background:#2563eb; color:#fff; border:none; border-radius:7px; padding:7px 14px; font-weight:700; cursor:pointer;}
    .reply-text { color:#2563eb; margin-top:5px; }
    .status-new { color:#b91c1c; font-weight:700; }
    .status-answered { color:#2db05a; font-weight:700; }
  </style>
</head>
<body>
  <div class="admin-wrap">
    <div class="admin-title">GoHigher ì±—ë´‡ ë¬¸ì˜ë‚´ì—­ (ê´€ë¦¬ì)</div>
    <div id="inquiry-list" class="inquiry-list"></div>
    <a href="javascript:history.back();" class="back-btn" style="margin-top:30px;">â† ì´ì „ìœ¼ë¡œ</a>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCgFLtAo8LETpHq44hxlT7QigCbIltk-Zk",
    authDomain: "gohigher-55e51.firebaseapp.com",
    projectId: "gohigher-55e51",
    storageBucket: "gohigher-55e51.firebasestorage.app",
    messagingSenderId: "487435343721",
    appId: "1:487435343721:web:dc5708c3a263214fba4ff8",
    measurementId: "G-KQ02L8DXG0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ë¬¸ì˜ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadUserChats() {
  const container = document.getElementById('inquiry-list');
  container.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

  // ëª¨ë“  ë©”ì‹œì§€(ì§ˆë¬¸+ë‹µë³€) ì‹œê°„ìˆœ ì •ë ¬ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
  const snap = await db.collection('user_chat')
    .orderBy('createdAt', 'asc') // ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ
    .get();

  if (snap.empty) {
    container.innerHTML = '<div style="color:#999">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // 1. ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë°°ì—´ë¡œ ì €ì¥
  const allMsgs = [];
  snap.forEach(doc => {
    const d = doc.data();
    allMsgs.push({ ...d, docId: doc.id });
  });

  // 2. ê° ì§ˆë¬¸(user)ë§ˆë‹¤ ë‹µë³€(bot)ì„ ì°¾ì•„ì„œ ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥
  for (let i = 0; i < allMsgs.length; i++) {
    const msg = allMsgs[i];
    if (msg.sender !== 'user') continue; // ì§ˆë¬¸ë§Œ

    // ì´ ì§ˆë¬¸ ì´í›„ì— ê°™ì€ sessionId, ê·¸ë¦¬ê³  qCreatedAt==msg.createdAt.seconds (ë˜ëŠ” ê°€ì¥ ê°€ê¹Œìš´ botë©”ì‹œì§€)ë¥¼ ë‹µë³€ìœ¼ë¡œ ì°¾ê¸°
    let answerMsg = null;
    for (let j = i + 1; j < allMsgs.length; j++) {
      const next = allMsgs[j];
      if (
        next.sender === 'bot' &&
        next.sessionId === msg.sessionId &&
        (
          (next.qCreatedAt && msg.createdAt && next.qCreatedAt === msg.createdAt.seconds) // qCreatedAt ë°©ì‹ ì§€ì›
          || !next.qCreatedAt // qCreatedAtì´ ì—†ëŠ” ì˜ˆì „ ë©”ì‹œì§€ë¼ë©´ sessionIdë§Œ ì¼ì¹˜í•˜ë©´ ë‹µë³€ìœ¼ë¡œ ì¸ì •
        )
      ) {
        answerMsg = next;
        break;
      }
    }

    const isAnswered = !!answerMsg;
    const time = msg.createdAt?.toDate?.() ? new Date(msg.createdAt.toDate()).toLocaleString() : '-';

    const div = document.createElement('div');
    div.className = 'inquiry-item';
    div.innerHTML = `
      <div class="inquiry-meta">
        <b>${msg.sessionId}</b> | <span style="font-size:0.94em;">${time}</span>
        <span class="status-${isAnswered ? 'answered' : 'new'}" style="margin-left:12px;">[${isAnswered ? 'ë‹µë³€ì™„ë£Œ':'ëŒ€ê¸°ì¤‘'}]</span>
      </div>
      <div class="inquiry-msg">${msg.message}</div>
      <div>
        <div class="reply-text">${isAnswered ? "ğŸŸ¢ ë‹µë³€: " + answerMsg.message : ""}</div>
        <form class="reply-form" data-session="${msg.sessionId}" data-qtime="${msg.createdAt?.seconds}" style="margin-top:7px;${isAnswered?'display:none':''}">
          <input type="text" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±..." required>
          <button type="submit">ë‹µë³€ ì „ì†¡</button>
        </form>
      </div>
    `;
    container.appendChild(div);

    // ë‹µë³€í¼ ì´ë²¤íŠ¸
    const form = div.querySelector('.reply-form');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const answer = form.querySelector('input').value.trim();
        if (!answer) return;
        await db.collection('user_chat').add({
          sessionId: form.dataset.session,
          sender: 'bot',
          message: answer,
          qCreatedAt: Number(form.dataset.qtime), // ì§ˆë¬¸ íƒ€ì„ìŠ¤íƒ¬í”„
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        alert('ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadUserChats();
      });
    }
  }
}
loadUserChats();

</script>
</body>
</html>
